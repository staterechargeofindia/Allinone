<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ISI ‚Äì Publish Product</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="css/style.css">

<style>
.img-preview{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin-bottom:10px;
}
.img-preview img{
  width:100%;
  border-radius:10px;
  object-fit:cover;
  height:80px;
}
.note{
  font-size:13px;
  color:#6b7280;
  margin-bottom:10px;
}
</style>
</head>

<body>

<!-- HEADER -->
<header class="topbar">
  <div onclick="history.back()">‚Üê</div>
  <div>Publish Product</div>
  <div onclick="goHome()">üè†</div>
</header>

<div class="container">

  <div class="card">
    <h3>Product Details</h3>

    <input id="pname" placeholder="Product Name">

    <textarea id="pdesc" placeholder="Product Description"></textarea>

    <select id="pcategory">
      <option value="">Select Category</option>
      <option>Fashion</option>
      <option>Beauty</option>
      <option>Electronics</option>
      <option>Grocery</option>
      <option>Vegetable</option>
      <option>Fruit</option>
      <option>Meat</option>
      <option>Biryani</option>
      <option>Mithai</option>
    </select>

    <input id="pprice" type="number" placeholder="Original Price">
    <input id="pdiscount" type="number" placeholder="Discount (%)">

    <div class="note">
      Final Price: ‚Çπ<span id="finalPrice">0</span>
    </div>

    <input type="file" id="pimages" multiple accept="image/*">

    <div class="note">
      You can upload 1 to 4 images
    </div>

    <div class="img-preview" id="preview"></div>

    <button onclick="publishProduct()">Publish Product</button>
  </div>

</div>

<!-- JS -->
<script src="js/data.js"></script>

<script>
function goHome(){ location.href="index.html"; }

/* ---------- merchant check ---------- */
const merchant = JSON.parse(localStorage.getItem("merchantSession"));
if(!merchant){
  location.href="merchant-login.html";
}

/* ---------- price calculation ---------- */
function calcPrice(){
  const price = Number(pprice.value || 0);
  const disc = Number(pdiscount.value || 0);
  const final = price - (price * disc / 100);
  finalPrice.innerText = final.toFixed(0);
}

pprice.oninput = calcPrice;
pdiscount.oninput = calcPrice;

/* ---------- image preview ---------- */
pimages.onchange = ()=>{
  preview.innerHTML = "";
  const files = Array.from(pimages.files).slice(0,4);

  files.forEach(file=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const img = document.createElement("img");
      img.src = e.target.result;
      preview.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
};

/* ---------- publish ---------- */
function publishProduct(){

  if(!pname.value || !pcategory.value || !pprice.value){
    alert("Please fill required product details");
    return;
  }

  const files = Array.from(pimages.files).slice(0,4);
  if(files.length === 0){
    alert("Please upload at least one image");
    return;
  }

  const images = [];
  let loaded = 0;

  files.forEach(file=>{
    const reader = new FileReader();
    reader.onload = e=>{
      images.push(e.target.result);
      loaded++;
      if(loaded === files.length){
        saveProduct(images);
      }
    };
    reader.readAsDataURL(file);
  });
}

function saveProduct(images){

  const products = getData("products");

  const original = Number(pprice.value);
  const discount = Number(pdiscount.value || 0);
  const final = original - (original * discount / 100);

  products.push({
    id: Date.now(),
    name: pname.value,
    desc: pdesc.value,
    category: pcategory.value,
    price: final.toFixed(0),
    originalPrice: original,
    discount: discount,
    images: images,
    img: images[0],              // main image for index
    merchantId: merchant.id,
    merchantShop: merchant.shopName,
    createdAt: new Date().toISOString()
  });

  setData("products", products);

  alert("Product published successfully");
  location.href="merchant-dashboard.html";
}
</script>

</body>
</html>
